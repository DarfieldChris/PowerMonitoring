<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Mosquitto Websockets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />

<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: auto;
  padding-top: 40px;
  position: relative;
  width: 960px;
}

.bullet { font: 10px sans-serif; }
.bullet .marker { stroke: #000; stroke-width: 2px; }
.bullet .tick line { stroke: #666; stroke-width: .5px; }
.bullet .range.s0 { fill: #eee; }
.bullet .range.s1 { fill: #ddd; }
.bullet .range.s2 { fill: #ccc; }
.bullet .measure.s0 { fill: red; }
.bullet .measure.s1 { fill: steelblue; }
.bullet .title { font-size: 14px; font-weight: bold; }
.bullet .subtitle { fill: #999; }

</style>

<script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="bullet.js"></script>

<script src="mqttws31.js" type="text/javascript"></script>
<script src="config.js" type="text/javascript"></script>

<script type="text/javascript">
    var mqtt;
    var reconnectTimeout = 2000;

    function MQTTconnect() {
        var new_host = document.getElementById('server').value;
        var new_port = parseInt(document.getElementById('port').value);
        
	    updateStatus("Trying to connect ... " + new_host +':' + new_port,
	    				"images/transfer.jpeg");
	    				
        mqtt = new Messaging.Client(
                        new_host,
                        //document.getElementById('server').value,
                        new_port,
                        //document.getElementById('port').value,
                        "web_" + parseInt(Math.random() * 100,
                        10));
        var options = {
            timeout: 3,
            useSSL: useTLS,
            cleanSession: cleansession,
            onSuccess: onConnect,
            onFailure: function (message) {
                $('#status').val("Connection failed: " + message.errorMessage + "Retrying");
                setTimeout(MQTTconnect, reconnectTimeout);
            }
        };

        mqtt.onConnectionLost = onConnectionLost;
        mqtt.onMessageArrived = onMessageArrived;

        if (username != null) {
            options.userName = username;
            options.password = password;
        }
        
        console.log("Host="+ host + ", port=" + port + " TLS = " + useTLS + " username=" + username + " password=" + password);
	    //updateStatus("Trying to connect ... " + document.getElementById('server').value +':' + document.getElementById('port').value,
	    //				"images/transfer.jpeg");
        mqtt.connect(options);
    }

    function onConnect() {
        updateStatus('Connected to ' + host + ':' + port, "images/connected.jpeg");
        // Connection succeeded; subscribe to our topic
        mqtt.subscribe(topic, {qos: 0});
        $('#topic').val(topic);
        
        //publish('Minecraft/output/98', '1');
    }

	function publish(dest, msg) {
	    updateStatus("Updating image ...","images/transfer.jpeg");
	  	message = new Messaging.Message(msg);
  		message.destinationName = dest;
  		mqtt.send(message); 
	};

	function updateStatus(text, img) {
	    document.images.namedItem('statusIcon').src = img;
	    $('#status').val(text);
	}

    function onConnectionLost(response) {
        setTimeout(MQTTconnect, reconnectTimeout);
        updateStatus("connection lost: " + responseObject.errorMessage + ". Reconnecting", "images/failed.jpeg");
    }

    function onMessageArrived(message) {
        var topic = message.destinationName;
console.log("AAA: %s - %d", topic, message.payloadBytes.length);
	if (message.payloadBytes.length > 250 ||
        	message.payloadString === null || 
        	!message.payloadString) {
	        $('#ws').prepend('<li>' + topic + ' = ' + '[BINARY FILE?]' + '</li>');
		updateStatus("Image updated!", "images/connected.jpeg");
        } else {
                var res = topic.split("/");
                var _id = res[res.length-1];
        	var payload = parseFloat( message.payloadString );
console.log("DDD");

        	$('#ws').prepend('<li>' + topic + ' = ' + payload + '</li>');
console.log("EEE");
                d3.selectAll(".bullet").each( function(d, i){
                   if (d.id == _id )
                   {
                      d.measures = [ payload ];

                      if ( d.markers[0] < payload )
                      {
                         d.markers = [ payload ];
                      }
                      window.wpd3.update();
                      console.log( d.title );    // just trying to demo my point, doesn't work
                   }
                });
        }
    };


    $(document).ready(function() {
        $('#server').val(host);
        $('#port').val(port);
        
        MQTTconnect();
    });

</script>

  </head>

  <body>
    <div data-role="page" id="index">
        <Div data-theme="b" data-role="header">
                <h1>Power Monitoring</h1>
        </div>

        <div data-role="content">
        	<table>
        		<tr>
        			<td valign="top">
        				<table>
        				    <tr><td>MQTT Server: <input type='text' id='server' size="15" maxlength="15"/>:<input type='text' id='port' size="8" maxlength="8" /></tr>
        					<tr><td>Topics: <input type='text' id='topic' disabled /></tr>
        					<tr><td>Status: <input type='text' id='status' size="65" disabled /></tr>
							<tr><td><img id='statusIcon' src='images/failed.jpeg' style="border-style: groove"></img></td></tr>
							<tr><td>Notes: </td></tr>
							<tr><td>Blue: connected to MQTT Server</td></tr>
							<tr><td>Red: not connected to MQTT Server</td></tr>
							<tr><td>Green: waiting for response</td></tr>
        				</table>
        			</td>
                      </tr> <tr>
        			<td>
						<div id="my_charts">
<script>

window.wpd3 = {};

var margin = {top: 5, right: 40, bottom: 20, left: 120},
    width = 960 - margin.left - margin.right,
    height = 50 - margin.top - margin.bottom;

var chart = d3.bullet()
    .width(width)
    .height(height);

d3.json("bullets.json", function(error, data) {
  var svg = d3.select("#my_charts").selectAll("svg")
      .data(data)
    .enter().append("svg")
      .attr("id", data.title)
      .attr("class", "bullet")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
      .call(chart);

  var title = svg.append("g")
      .style("text-anchor", "end")
      .attr("transform", "translate(-6," + height / 2 + ")");

  title.append("text")
      .attr("class", "title")
      .text(function(d) { return d.title; });

  title.append("text")
      .attr("class", "subtitle")
      .attr("dy", "1em")
      .text(function(d) { return d.subtitle; });

console.log("EEE3");
window.wpd3.update = function() {
console.log("EEE1");
    svg.datum(randomize).call(chart.duration(1000));
};


});

function randomize(d) {
  //if (!d.randomizer) d.randomizer = randomizer(d);
  //d.ranges = d.ranges.map(d.randomizer);
  //d.markers = d.markers.map(d.randomizer);
  //d.measures = d.measures.map(d.randomizer);
  return d;
}

</script>

						</div>
					</td>
				</tr>
				<tr>
					<td colspan="3">
						<div data-role="collapsible" id="subscribed" >
		   					<h3>Subscribed events</h3>
                                                        <div style="height:100px; overflow: auto;">
        					<ul id='ws' style="font-family: 'Courier New', Courier, monospace; border-style: groove";></ul>
                                                        </div>
						</div>
						
					</td>
				</tr>
			</table>
		</div>
	</div>


  </body>
</html>
